# 交易所数据源切换修复测试指南

## 🧪 快速测试步骤

### 1. 启动和访问
```bash
# 启动前端服务器
cd frontend
npm run dev

# 访问地址
http://localhost:3001/auth/login  # 先登录
http://localhost:3001/trading    # 再访问交易控制台
```

### 2. 测试交易所切换功能

#### 测试场景 A：模拟数据 → CoinGecko
1. **初始状态检查**
   - 默认应该连接到 CoinGecko
   - 观察价格数据更新频率（约30秒一次）
   - 查看交易对标识显示 "BTC/USDT [COINGECKO]"

2. **切换到模拟数据**
   - 点击顶部交易所选择器
   - 选择"模拟数据"
   - 观察连接状态变化：未连接 → 连接中 → 已连接

3. **验证数据变化**
   - 价格数据应该开始每秒更新
   - 数字跳动更频繁，波动更大
   - 交易对标识变为 "BTC/USDT [MOCK]"
   - K线图应该重新生成

#### 测试场景 B：快速连续切换
1. **连续切换多个交易所**
   - CoinGecko → 模拟数据 → Binance → OKX
   - 每次切换等待3-5秒
   - 观察是否有数据混合现象

2. **验证数据隔离**
   - 每次切换后数据应该完全重置
   - 不应该看到前一个交易所的数据特征
   - 连接状态应该准确反映

### 3. 关键验证点

#### ✅ 数据更新频率
- **模拟数据**: 每秒更新，价格波动大
- **CoinGecko**: 约30秒更新，价格相对稳定
- **Binance/OKX**: 模拟高频更新

#### ✅ 视觉指示
- 交易对旁边的交易所标识正确显示
- 连接状态指示器状态准确
- 悬停详情显示正确的交易所信息

#### ✅ 数据一致性
- 切换后价格列表完全更新
- K线图重新生成
- 订单簿数据对应正确的交易所

### 4. 控制台日志检查

打开浏览器开发者工具，查看控制台输出：

#### 期望的日志模式：
```
🔄 切换交易所: coingecko → mock
📊 切换到数据源: mock
📊 数据源变化: coingecko → mock
🔄 重置市场数据状态...
📊 取消订阅价格数据更新...
📈 取消订阅K线数据更新...
📋 取消订阅 BTCUSDT 订单簿数据更新...
📊 订阅价格数据更新...
📈 订阅K线数据更新...
📋 订阅 BTCUSDT 订单簿数据更新...
✅ 交易所 mock 连接成功
```

### 5. 问题排查

#### 如果数据更新频率没有变化：
1. 检查控制台是否有数据重置日志
2. 确认数据源切换日志是否正确
3. 刷新页面重试

#### 如果交易所标识没有更新：
1. 检查 `selectedExchange` 状态是否正确
2. 确认组件是否正确接收新的 props

#### 如果连接状态不准确：
1. 检查 `useExchangeManager` 的状态更新
2. 确认连接状态监控是否正常工作

### 6. 性能验证

#### 网络请求模式：
- **模拟数据**: 无外部API调用，数据本地生成
- **CoinGecko**: 每30秒调用一次CoinGecko API
- **切换时**: 应该停止旧的请求，开始新的请求模式

#### 内存使用：
- 切换交易所时旧数据应该被清理
- 不应该有内存泄露

### 7. 用户体验验证

#### 平滑性：
- 切换过程应该有明确的状态反馈
- 不应该出现空白或错误状态

#### 响应性：
- 点击交易所选择器应该立即响应
- 状态变化应该及时反映

#### 信息透明度：
- 用户应该清楚知道当前使用的数据源
- 连接状态应该准确显示

## 🐛 常见问题

### Q: 切换后数据还是之前的更新频率
**A**: 检查是否有以下日志：
- "数据源变化" 日志
- "重置市场数据状态" 日志
- 重新订阅的日志

### Q: 交易所标识没有更新
**A**: 确认 `selectedExchange` 状态是否正确更新

### Q: 连接状态显示错误
**A**: 检查 `useExchangeManager` 的状态同步

## ✅ 成功标准

修复成功的标准：
1. 切换交易所时数据完全重置
2. 不同交易所的更新频率明显不同
3. 交易所标识正确显示
4. 没有数据混合现象
5. 连接状态准确反映
6. 控制台日志完整清晰

按照这个测试指南，您应该能够验证交易所切换功能是否正常工作，以及数据源隔离是否有效。
