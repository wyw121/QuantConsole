<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åç«¯æµ‹è¯• - QuantConsole</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #dee2e6;
        }

        .main {
            flex: 1;
            padding: 30px;
        }

        .status-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #495057;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-success {
            color: #28a745;
            font-weight: bold;
        }

        .status-error {
            color: #dc3545;
            font-weight: bold;
        }

        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }

        .status-neutral {
            color: #6c757d;
        }

        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            height: 500px;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        .controls {
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .feature-highlight {
            background: linear-gradient(90deg, #17a2b8, #138496);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .feature-highlight h3 {
            margin: 0 0 10px 0;
        }

        .demo-data-info {
            background: linear-gradient(90deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ QuantConsole æ™ºèƒ½åç«¯æµ‹è¯•</h1>
            <p>ä¼˜å…ˆæµ‹è¯•æ¼”ç¤ºæ•°æ®ç³»ç»Ÿï¼Œæ™ºèƒ½å¤„ç†ç½‘ç»œé™åˆ¶</p>
        </div>

        <div class="content">
            <div class="sidebar">
                <div class="demo-data-info">
                    <h3>ğŸ­ æ¼”ç¤ºæ•°æ®ç³»ç»Ÿ</h3>
                    <p>æœ¬ç³»ç»ŸåŒ…å«å®Œæ•´çš„æ¼”ç¤ºæ•°æ®ç”Ÿæˆå™¨ï¼Œæ— éœ€å¤–éƒ¨APIå³å¯æ­£å¸¸è¿è¡Œæ‰€æœ‰åŠŸèƒ½ã€‚</p>
                </div>

                <div class="status-card">
                    <div class="status-header">ğŸ“Š ç³»ç»ŸçŠ¶æ€</div>
                    <div class="status-item">
                        <span>åç«¯æœåŠ¡</span>
                        <span id="backend-status" class="status-neutral">æœªæµ‹è¯•</span>
                    </div>
                    <div class="status-item">
                        <span>æ¼”ç¤ºæ•°æ®</span>
                        <span id="demo-status" class="status-neutral">æœªæµ‹è¯•</span>
                    </div>
                    <div class="status-item">
                        <span>OKX API</span>
                        <span id="okx-status" class="status-neutral">æœªæµ‹è¯•</span>
                    </div>
                    <div class="status-item">
                        <span>Binance API</span>
                        <span id="binance-status" class="status-neutral">æœªæµ‹è¯•</span>
                    </div>
                    <div class="status-item">
                        <span>CoinGecko API</span>
                        <span id="coingecko-status" class="status-neutral">æœªæµ‹è¯•</span>
                    </div>
                </div>

                <div class="feature-highlight">
                    <h3>ğŸ’¡ SSRä»£ç†é…ç½®</h3>
                    <p>è¦è®¿é—®çœŸå®APIæ•°æ®ï¼Œè¯·è®¾ç½®ç¯å¢ƒå˜é‡ï¼š</p>
                    <code style="display: block; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 4px;">
                        HTTP_PROXY=http://proxy:port<br>
                        HTTPS_PROXY=http://proxy:port
                    </code>
                </div>
            </div>

            <div class="main">
                <div class="controls">
                    <button onclick="startSmartTest()" id="test-btn">ğŸš€ å¼€å§‹æ™ºèƒ½æµ‹è¯•</button>
                    <button onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
                    <button onclick="testDemoOnly()">ğŸ­ ä»…æµ‹è¯•æ¼”ç¤ºæ•°æ®</button>
                    <button onclick="testExternalAPIs()">ğŸŒ æµ‹è¯•å¤–éƒ¨API</button>
                </div>

                <div class="log-container" id="log"></div>
            </div>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let testRunning = false;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeColors = {
                info: '#0c5460',
                success: '#155724',
                error: '#721c24',
                warning: '#856404'
            };
            logElement.innerHTML += `<span style="color: #666; font-weight: bold;">[${timestamp}]</span> <span style="color: ${typeColors[type]};">${message}</span><br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status-${status}`;
            element.textContent = text || status;
        }

        function clearLog() {
            logElement.innerHTML = '';
            log('ğŸ“ æ—¥å¿—å·²æ¸…ç©ºï¼Œå‡†å¤‡å¼€å§‹æ–°çš„æµ‹è¯•...', 'info');
        }

        function setTestingState(running) {
            testRunning = running;
            document.getElementById('test-btn').disabled = running;
            document.getElementById('test-btn').textContent = running ? 'ğŸ”„ æµ‹è¯•ä¸­...' : 'ğŸš€ å¼€å§‹æ™ºèƒ½æµ‹è¯•';
        }

        // æ™ºèƒ½æµ‹è¯•ä¸»å‡½æ•°
        async function startSmartTest() {
            if (testRunning) return;

            setTestingState(true);
            log('ğŸ¯ å¯åŠ¨æ™ºèƒ½åç«¯æµ‹è¯•ç³»ç»Ÿ...', 'info');
            log('ğŸ’¡ ä¼˜å…ˆçº§: æ¼”ç¤ºæ•°æ® > å¤–éƒ¨APIï¼ˆç½‘ç»œé™åˆ¶å¯èƒ½å¯¼è‡´å¤±è´¥ï¼‰', 'warning');

            try {
                // 1. æµ‹è¯•åç«¯å¥åº·çŠ¶æ€
                const healthOk = await testBackendHealth();

                // 2. ä¼˜å…ˆæµ‹è¯•æ¼”ç¤ºæ•°æ®ç³»ç»Ÿ
                const demoOk = await testDemoDataSystem();

                // 3. æµ‹è¯•å¤–éƒ¨APIï¼ˆé¢„æœŸå¯èƒ½å¤±è´¥ï¼‰
                const externalResults = await testExternalAPIs();

                // 4. ç”Ÿæˆæ™ºèƒ½æŠ¥å‘Š
                generateSmartReport(healthOk, demoOk, externalResults);

            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
            } finally {
                setTestingState(false);
            }
        }

        // æµ‹è¯•åç«¯å¥åº·çŠ¶æ€
        async function testBackendHealth() {
            log('ğŸ¥ æ£€æµ‹åç«¯æœåŠ¡å¥åº·çŠ¶æ€...', 'info');
            updateStatus('backend-status', 'warning', 'æ£€æµ‹ä¸­...');

            try {
                const response = await fetch('http://localhost:8080/api/market/health');
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… åç«¯æœåŠ¡æ­£å¸¸: ${data.message}`, 'success');
                    updateStatus('backend-status', 'success', 'âœ… æ­£å¸¸');
                    return true;
                } else {
                    log(`âŒ åç«¯æœåŠ¡å“åº”å¼‚å¸¸: HTTP ${response.status}`, 'error');
                    updateStatus('backend-status', 'error', `âŒ HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus('backend-status', 'error', 'âŒ è¿æ¥å¤±è´¥');
                return false;
            }
        }

        // æµ‹è¯•æ¼”ç¤ºæ•°æ®ç³»ç»Ÿ
        async function testDemoDataSystem() {
            log('ğŸ­ æµ‹è¯•æ ¸å¿ƒæ¼”ç¤ºæ•°æ®ç³»ç»Ÿ...', 'info');
            updateStatus('demo-status', 'warning', 'æµ‹è¯•ä¸­...');

            try {
                // æµ‹è¯•ä¸æŒ‡å®šæ•°æ®æºï¼ˆåº”è¯¥è‡ªåŠ¨ä½¿ç”¨æ¼”ç¤ºæ•°æ®ï¼‰
                const response = await fetch('http://localhost:8080/api/market/kline?symbol=BTCUSDT&interval=1h&limit=5');

                if (response.ok) {
                    const data = await response.json();

                    if (Array.isArray(data) && data.length > 0) {
                        log(`âœ… æ¼”ç¤ºæ•°æ®ç³»ç»Ÿæ­£å¸¸: è·å¾— ${data.length} æ¡Kçº¿æ•°æ®`, 'success');
                        log(`ğŸ“Š ç¤ºä¾‹æ•°æ®: BTCUSDT ä»·æ ¼=${data[0].close}, æˆäº¤é‡=${data[0].volume}`, 'info');
                        log(`ğŸ• æ—¶é—´èŒƒå›´: ${new Date(data[0].timestamp).toLocaleString()} è‡³ ${new Date(data[data.length-1].timestamp).toLocaleString()}`, 'info');
                        updateStatus('demo-status', 'success', 'âœ… æ­£å¸¸');
                        return true;
                    } else {
                        log('âŒ æ¼”ç¤ºæ•°æ®æ ¼å¼é”™è¯¯æˆ–ä¸ºç©º', 'error');
                        updateStatus('demo-status', 'error', 'âŒ æ ¼å¼é”™è¯¯');
                        return false;
                    }
                } else {
                    log(`âŒ æ¼”ç¤ºæ•°æ®è¯·æ±‚å¤±è´¥: HTTP ${response.status}`, 'error');
                    updateStatus('demo-status', 'error', `âŒ HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`âŒ æ¼”ç¤ºæ•°æ®ç³»ç»Ÿé”™è¯¯: ${error.message}`, 'error');
                updateStatus('demo-status', 'error', 'âŒ ç³»ç»Ÿé”™è¯¯');
                return false;
            }
        }

        // ä»…æµ‹è¯•æ¼”ç¤ºæ•°æ®
        async function testDemoOnly() {
            if (testRunning) return;

            setTestingState(true);
            log('ğŸ­ ä¸“é¡¹æµ‹è¯•ï¼šæ¼”ç¤ºæ•°æ®ç³»ç»Ÿ...', 'info');

            try {
                const healthOk = await testBackendHealth();
                if (healthOk) {
                    const demoOk = await testDemoDataSystem();
                    if (demoOk) {
                        log('ğŸ‰ æ¼”ç¤ºæ•°æ®ç³»ç»Ÿå®Œå…¨æ­£å¸¸ï¼ç³»ç»Ÿå¯ä»¥æ­£å¸¸è¿è¡Œã€‚', 'success');
                    } else {
                        log('âŒ æ¼”ç¤ºæ•°æ®ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®ã€‚', 'error');
                    }
                }
            } finally {
                setTestingState(false);
            }
        }

        // æµ‹è¯•å¤–éƒ¨API
        async function testExternalAPIs() {
            log('ğŸŒ æµ‹è¯•å¤–éƒ¨APIï¼ˆé¢„æœŸå¯èƒ½å› ç½‘ç»œé™åˆ¶å¤±è´¥ï¼‰...', 'warning');

            const results = {
                okx: await testSpecificAPI('OKX', 'okx', 'okx-status'),
                binance: await testSpecificAPI('Binance', 'binance', 'binance-status'),
                coingecko: await testSpecificAPI('CoinGecko', 'coingecko', 'coingecko-status')
            };

            return results;
        }

        // æµ‹è¯•ç‰¹å®šAPI
        async function testSpecificAPI(name, source, statusId) {
            log(`ğŸ”¸ æµ‹è¯•${name}æ•°æ®æº...`, 'info');
            updateStatus(statusId, 'warning', 'æµ‹è¯•ä¸­...');

            try {
                const timeout = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), 25000)
                );

                const request = fetch(`http://localhost:8080/api/market/kline?symbol=BTCUSDT&source=${source}&interval=1d&limit=5`);

                const response = await Promise.race([request, timeout]);

                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data) && data.length > 0) {
                        log(`âœ… ${name}æ•°æ®è·å–æˆåŠŸ: ${data.length}æ¡è®°å½•`, 'success');
                        updateStatus(statusId, 'success', 'âœ… æ­£å¸¸');
                        return true;
                    } else {
                        log(`âš ï¸ ${name}è¿”å›ç©ºæ•°æ®`, 'warning');
                        updateStatus(statusId, 'warning', 'âš ï¸ ç©ºæ•°æ®');
                        return false;
                    }
                } else {
                    log(`âŒ ${name}è¯·æ±‚å¤±è´¥: HTTP ${response.status} (å¯èƒ½æ˜¯ç½‘ç»œé™åˆ¶)`, 'error');
                    updateStatus(statusId, 'error', 'âŒ ç½‘ç»œé™åˆ¶');
                    return false;
                }
            } catch (error) {
                const isNetworkError = error.message.includes('è¶…æ—¶') ||
                                     error.message.includes('ç½‘ç»œ') ||
                                     error.message.includes('è¿æ¥');

                log(`âŒ ${name}è¿æ¥å¤±è´¥: ${error.message} ${isNetworkError ? '(ç½‘ç»œé™åˆ¶)' : ''}`, 'error');
                updateStatus(statusId, 'error', 'âŒ è¿æ¥å¤±è´¥');
                return false;
            }
        }

        // ç”Ÿæˆæ™ºèƒ½æŠ¥å‘Š
        function generateSmartReport(healthOk, demoOk, externalResults) {
            log('', 'info');
            log('=' .repeat(60), 'info');
            log('ğŸ“Š æ™ºèƒ½æµ‹è¯•æŠ¥å‘Š', 'info');
            log('=' .repeat(60), 'info');

            // æ ¸å¿ƒç³»ç»ŸçŠ¶æ€
            log(`ğŸ¥ åç«¯æœåŠ¡: ${healthOk ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`, healthOk ? 'success' : 'error');
            log(`ğŸ­ æ¼”ç¤ºæ•°æ®: ${demoOk ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`, demoOk ? 'success' : 'error');

            // å¤–éƒ¨APIçŠ¶æ€
            const externalCount = Object.values(externalResults).filter(Boolean).length;
            log(`ğŸŒ å¤–éƒ¨API: ${externalCount}/3 å¯ç”¨`, externalCount > 0 ? 'success' : 'warning');
            log(`   - OKX: ${externalResults.okx ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨ (ç½‘ç»œé™åˆ¶)'}`, externalResults.okx ? 'success' : 'warning');
            log(`   - Binance: ${externalResults.binance ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨ (ç½‘ç»œé™åˆ¶)'}`, externalResults.binance ? 'success' : 'warning');
            log(`   - CoinGecko: ${externalResults.coingecko ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨ (ç½‘ç»œé™åˆ¶)'}`, externalResults.coingecko ? 'success' : 'warning');

            // æ™ºèƒ½ç»“è®º
            log('', 'info');
            if (healthOk && demoOk) {
                log('ğŸ‰ æ ¸å¿ƒç³»ç»Ÿå®Œå…¨æ­£å¸¸ï¼', 'success');
                log('ğŸ’¡ æ‚¨çš„QuantConsoleäº¤æ˜“æ§åˆ¶å°å·²å‡†å¤‡å°±ç»ªã€‚', 'success');
                log('ğŸ­ æ¼”ç¤ºæ•°æ®ç³»ç»Ÿå¯ä»¥æä¾›å®Œæ•´çš„äº¤æ˜“åŠŸèƒ½ä½“éªŒã€‚', 'info');

                if (externalCount === 0) {
                    log('', 'info');
                    log('âš ï¸ å¤–éƒ¨APIæš‚æ—¶ä¸å¯ç”¨ï¼ˆç½‘ç»œé™åˆ¶ï¼‰', 'warning');
                    log('ğŸ”§ è¦è®¿é—®çœŸå®å¸‚åœºæ•°æ®ï¼Œè¯·é…ç½®SSRä»£ç†ï¼š', 'warning');
                    log('   export HTTP_PROXY=http://your-proxy:port', 'info');
                    log('   export HTTPS_PROXY=http://your-proxy:port', 'info');
                    log('   ç„¶åé‡å¯åç«¯æœåŠ¡', 'info');
                } else {
                    log(`âœ¨ ${externalCount}ä¸ªå¤–éƒ¨APIå¯ç”¨ï¼Œå¯è·å–çœŸå®å¸‚åœºæ•°æ®ï¼`, 'success');
                }
            } else {
                log('âŒ ç³»ç»Ÿå­˜åœ¨é—®é¢˜ï¼Œéœ€è¦ä¿®å¤ã€‚', 'error');
                if (!healthOk) {
                    log('ğŸ”§ è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨åœ¨localhost:8080', 'error');
                }
                if (!demoOk) {
                    log('ğŸ”§ è¯·æ£€æŸ¥æ¼”ç¤ºæ•°æ®ç”Ÿæˆå™¨é…ç½®', 'error');
                }
            }

            log('=' .repeat(60), 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', function() {
            log('ğŸ”§ é¡µé¢åŠ è½½å®Œæˆï¼Œç³»ç»Ÿå‡†å¤‡å°±ç»ª...', 'info');
            log('ğŸ’¡ ç‚¹å‡»"å¼€å§‹æ™ºèƒ½æµ‹è¯•"æŒ‰é’®å¼€å§‹å…¨é¢æ£€æµ‹', 'info');
        });
    </script>
</body>
</html>
